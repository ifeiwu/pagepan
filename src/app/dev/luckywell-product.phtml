<?php
$get_cid = $this->pagevar['get_cid'] ?: 'all';
$page_alias = $this->pagevar['page_alias'];
$page_title = $this->pagevar['page_title'];
// 组件配置
$dataset_id = 11009;
$ukid = 'lfxmwrlb';
$this->assign('ukid', $ukid);
$this->assign('setting', [
    'dataset.id' => $dataset_id,
    'dataset.table' => 'item',
    'join.id' => 10,
    'join.alias' => 'products-detail',
    'ukid' => $ukid
]);

$db = db();
// 异步获取产品数据分页列表
if (Request::isAjax()) {
    $attrs = $_POST['attrs'];
    $perpage = $_POST['perpage'];
    $pagenum = $_POST['pagenum'];
    $pagenum = $pagenum ? $pagenum - 1 : 0;
    $data = [];
    $where = [['page_id', '=', $dataset_id], 'AND', ['state', '=', 1], 'AND', ['type', '=', 1]];
    // 选择分类查询
    if ($get_cid != 'all') {
        $where[] = 'AND';
        $where[] = ['level', 'like', '%,' . $get_cid . ',%'];
    }
    // 勾选属性查询
    if ($attrs) {
        $where[] = 'AND';
        $where[] = '(';
        foreach ($attrs as $val) {
            $where[] = ['attrs', 'like', '%"' . $val . '"%'];
            $where[] = 'AND';
        }
        array_pop($where);
        $where[] = ')';
    }
    $total = $db->count('item', $where);
    $items = $db->select('item', '*', $where, 'sortby DESC, id DESC', [($pagenum - 1) * $perpage, $perpage]);
    ItemModel::setSetting($this->setting);
    foreach ($items as $item) {
        ItemModel::setItem($item);
        $image = ItemModel::getImage('s_');
        $link_url = ItemModel::getLink()['link_url'];
        $params = ItemModel::getMore('params');
        $data[] = [
            'link_url' => $link_url,
            'image' => $image,
            'title' => $item['title'],
            'diatemer' => $params['diatemer'] ?: '/',
            'height' => $params['height'] ?: '/',
            'length' => $params['length'] ?: '/',
            'width' => $params['width'] ?: '/',
            'mounting_type' => $params['mounting_type'] ?: '/',
            'spl' => $params['spl'] ?: '/',
            'rated_voltage' => $params['rated_voltage'] ?: '/',
            'utime' => $item['utime']
        ];
    }
    exit(json_encode([
        'last_page' => ceil($total / $perpage),
        'last_row' => $total,
        'data' => $data
    ]));
}

// 分类列表
$categorys = $db->select('item', '*', [['state', '=', 1], 'AND', ['type', '=', 2], 'AND', ['page_id', '=', $dataset_id]], 'sortby DESC, id DESC');

// 当前分类多层级别
$levels = [];
if (!empty($categorys) && $get_cid != 'all') {
    $levels = helper('db/getItemLevels', [$get_cid]);
}
?>
<section <?=$this->uikit->getSettingAttrs('component', ['style'=>'--bgc-lg:var(--mix-39)'])?>>
    <div <?=$this->uikit->getSettingAttrs('container', ['class'=>'container container-3xl'])?>>

        <div class="banner relative w-expand-screen bg-cover bg-norepeat bg-center h-25 h-35-lg w-full" style="--bgi:url(<?=$this->asset('data/file/product-banner.jpg', true)?>)">
            <div class="absolute" style="bottom:40%;left:7%;">
                <h2 class="f-13 mix-40">PRODUCT</h2>
                <h1 class="normal f-21 mix-40">产品中心</h1>
            </div>
        </div>

        <div class="grid relative z-10">
            <div class="col-span-12 col-span-3-lg hidden block-lg">
                <?php
                if ( $categorys ):
                    $page_alias = $get_id ? $join_alias : $page_alias; // 如果是详情页就使用上级页面别名
                ?>
                    <div <?=$this->uikit->getSettingAttrs('category', $_setting_category['root'])?>>
                        <style>
                            @import 'assets/js/lib/metismenu/metismenu.css' layer(lib);
                            @import 'assets/js/lib/metismenu/vertical.css' layer(lib);
                            @layer {
                                [<?=$ukid?>] .sidebar-nav .metismenu {
                                    --hover-color: var(--mix);
                                    --active-color: var(--primary)
                                }

                                [<?=$ukid?>] .sidebar-nav .metismenu > li > a {
                                    padding: 1.2rem 2rem;
                                }

                                [<?=$ukid?>] .sidebar-nav .metismenu > li > a:hover {
                                    padding-left: 2.2rem;
                                }

                                [<?=$ukid?>] .sidebar-nav .metismenu > li.mm-active > a {
                                    font-weight: bold;
                                }

                                [<?=$ukid?>] .sidebar-nav .metismenu .mm-active > a:before {
                                    width: 12px;
                                    height: 12px;
                                    left: 10px;
                                    border: 0.25rem solid var(--primary);
                                }

                                [<?=$ukid?>] .sidebar-nav .metismenu > li > a:before {
                                    content: "";
                                    position: absolute;
                                    width: 10px;
                                    height: 10px;
                                    left: 12px;
                                    top: 50%;
                                    border: 0.25rem solid var(--mix-30);
                                    border-radius: 50%;
                                    transform: translateY(-50%);
                                    transition: all 0.35s;
                                }

                                [<?=$ukid?>] .sidebar-nav .metismenu > li:not(.mm-active) > a:hover:before {
                                    border: 0.25rem solid var(--mix-15);
                                    border-radius: 50%;
                                    transform: translateY(-50%);
                                }

                                [<?=$ukid?>] .sidebar-nav .metismenu > li > a:after {
                                    content: "";
                                    position: absolute;
                                    bottom: 0;
                                    left: 0;
                                    right: 0;
                                    height: 1px;
                                    background-color: var(--mix-32);
                                    transition: all 0.2s;
                                }

                                [<?=$ukid?>] .sidebar-nav .metismenu ul li a:hover {
                                    padding-left: 1.5rem;
                                    background-color: var(--mix-38);
                                }

                                [<?=$ukid?>] .sidebar-nav .metismenu ul li.mm-active a {
                                    background-color: var(--primary);
                                    color: var(--primary-20);
                                }
                            }
                        </style>
                        <div class="flex items-center justify-between bg-primary f-13 py-8 px-8 primary-20" style="margin-top:-4.48rem;">
                            <div>悦福科技产品分类</div>
                            <div>
                                <svg width="38" height="38" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M15 15m-4 0a4 4 0 1 0 8 0a4 4 0 1 0 -8 0" /><path d="M18.5 18.5l2.5 2.5" /><path d="M4 6h16" /><path d="M4 12h4" /><path d="M4 18h4" /></svg>
                            </div>
                        </div>
                        <div class="category sidebar-nav">
                            <ul class="metismenu invisible list-none mb-0 f-8" data-id="<?=$this->pagevar['get_cid'] ?: $item['pid']?>">
                                <?php
                                $categorys = helper('arr/tree', [$categorys]);
                                $tree_menu_options = ['url' => $page_alias . '/category/{id}.html', 'arrow' => 'arrow', 'arrow_add_url' => true];
                                $tree_menu_html = '';
                                helper('arr/tree_menu', [$categorys, &$tree_menu_html, 0, 3, 0, $tree_menu_options]);
                                echo $tree_menu_html;
                                ?>
                            </ul>
                        </div>

                        <script>
                            require(['metismenu/metismenu'], function () {
                                const $component = $('[<?=$ukid?>]');
                                const $metismenu = $component.find('.metismenu');
                                const category_id = $metismenu.data('id');
                                const $category = $metismenu.find('[data-id="' + category_id + '"]')
                                const category_pid = $category.data('pid');

                                $metismenu.find('[data-id="' + category_pid + '"]').addClass('mm-active');
                                $category.addClass('mm-active');
                                $metismenu.metisMenu();
                                $metismenu.removeClass('invisible');
                            });
                        </script>
                    </div>
                <?php endif?>

            </div>
            <div class="col-span-12 col-span-9-lg">
                <div <?=$this->uikit->getSettingAttrs('dataview', ['class'=>'bg-mix-40 px-12-md py-15 mt-n23-lg', 'style'=>'--minh:60rem'])?>>

                    <div class="flex justify-between mb-12 pb-8 bb-1 b-mix-30">
                        <div class="">
                            <?php if ( count($levels) == 2 ): ?>
                                <h6 class="normal"><?=$levels[0]['title']?></h6>
                                <h2><?=$levels[1]['title']?></h2>
                            <?php elseif ( count($levels) == 1 ): ?>
                                <h2><?=$levels[0]['title']?></h2>
                            <?php else: ?>
                                <h2><?=$page_title?></h2>
                            <?php endif?>
                        </div>
                        <div>
                            <a href="javascript:location.reload()" class="btn btn-secondary">重置</a>
                        </div>
                    </div>

                    <div id="menu_attrs" class="flex flex-col gy-10 mb-15">
                        <?php
                        $menu_attrs = SITE["menu_attrs_pid_{$get_cid}"] ?? '[]';
                        $menu_attrs = array_filter(json_decode2($menu_attrs),fn($o) => $o['state'] === 1);
                        foreach ($menu_attrs as $attr1):
                        ?>
                            <div class="flex gx-8">
                                <div class="primary bold nowrap"><?=$attr1['title']?>></div>
                                <div>
                                    <ul class="flex flex-wrap gx-8 gy-4">
                                        <?php
                                        $children = $attr1['children'] ?? [];
                                        foreach (array_filter($children, fn($o) => $o['state'] === 1) as $attr2):
                                        ?>
                                            <li>
                                                <label class="flex gx-1 items-center lh-1">
                                                    <div>
                                                        <input type="checkbox" class="form-checkbox" value="<?="{$attr1['id']}:{$attr2['id']}"?>">
                                                    </div>
                                                    <div class="nowrap"><?=$attr2['title']?></div>
                                                </label>
                                            </li>
                                        <?php endforeach; ?>
                                    </ul>
                                </div>
                            </div>
                        <?php endforeach; ?>
                    </div>

                    <div>
                        <div id="datatable" style="width:100%"></div>
                        <script>
                            require(['lib/tabulator/tabulator', 'css!lib/tabulator/tabulator'], function(Tabulator) {
                                const tabulator = new Tabulator('#datatable', {
                                    ajaxURL: location.href,
                                    ajaxConfig: 'POST',
                                    ajaxParams: { cid: '<?=$get_cid?>' },
                                    dataSendParams: {
                                        'page': 'pagenum',
                                        'size': 'perpage'
                                    },
                                    pagination: true,
                                    paginationSize: 10,
                                    paginationInitialPage: 1,
                                    // paginationSizeSelector: [10, 20, 30, 40, 50],
                                    paginationMode: 'remote',
                                    // paginationCounter: 'rows',
                                    // selectableRows: true,
                                    // selectableRowsRangeMode: 'click',
                                    layout: 'fitDataFill',
                                    height: '100%',
                                    filterMode: 'remote',
                                    addRowPos: 'top',
                                    rowHeight: 85,
                                    columnDefaults: {
                                        vertAlign: 'middle',
                                        hozAlign: 'center',
                                        resizable: false,
                                        headerSort: false
                                    },
                                    columns: [
                                        { title: 'IMAGE .', field: 'image', width: 85, frozen: true, formatter: function(cell) {
                                                let data = cell.getData()
                                                let title = cell.getValue()
                                                let image = data.image
                                                if (image) {
                                                    image = `${image}?${data.utime}`
                                                    return `<a href="${data.link_url}"><img src="${image}" alt=""></a>`
                                                } else {
                                                    return title
                                                }
                                            }
                                        },
                                        { title: 'PART NUMBER .', field: 'title', hozAlign: 'left', formatter: function(cell) {
                                                let data = cell.getData()
                                                let title = cell.getValue()
                                                return `<a href="${data.link_url}">${title}</a>`
                                            }
                                        },
                                        { title: 'Diameter', field: 'diatemer' },
                                        { title: 'HEIGHT', field: 'height' },
                                        { title: 'LENGTH', field: 'length' },
                                        { title: 'WIDTH', field: 'width' },
                                        { title: 'MOUNTING TYPE', field: 'mounting_type' },
                                        { title: 'SPL [DB]', field: 'spl' },
                                        { title: 'RATED VOLTAGE', field: 'rated_voltage' },
                                    ],
                                    locale: true,
                                    langs: {
                                        'zh-cn': {
                                            'data': {
                                                'loading': '产品列表加载中...',
                                                'error': '加载产品列表出错~'
                                            },
                                            'groups': {
                                                'item': 'item',
                                                'items': 'items'
                                            },
                                            'pagination': {
                                                'page_size': '页码',
                                                'page_title': '',
                                                'first': '首页',
                                                'first_title': '',
                                                'last': '尾页',
                                                'last_title': '',
                                                'prev': '上一页',
                                                'prev_title': '',
                                                'next': '下一页',
                                                'next_title': '',
                                                'all': 'All',
                                                'counter': {
                                                    'showing': '显示',
                                                    'of': '共',
                                                    'rows': '个产品',
                                                    'pages': 'pages'
                                                }
                                            }
                                        }
                                    }
                                })

                                tabulator.on('rowClick', function(e, row) {
                                    let data = row.getData()
                                    location.href = data.link_url
                                })

                                const $menu_attrs = $('#menu_attrs')
                                $menu_attrs.on('change', 'input[type="checkbox"]', function() {
                                    let values = $('input[type="checkbox"]:checked').map(function() {
                                        return $(this).val();
                                    }).get();
                                    tabulator.setData(location.href, { cid: '<?=$get_cid?>', attrs: values }, 'POST');
                                })
                            })
                        </script>
                    </div>

                </div>
            </div>
        </div>
    </div>
</section>